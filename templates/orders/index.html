{% extends 'base.html' %}
{% load static %}

{% block title %}Главная{% endblock %}

{% block content %}
<div id="main-page">
    <h2 class="page-title">Все товары</h2>
    <div id="product-list">
        {% for product in products %}
            <div class="product-item">
                <a href="{% url 'product_detail' pk=product.pk %}">
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
                    <h4 class="product-name">{{ product.name }}</h4>
                    <p class="product-price">{{ product.price }} руб.</p>
                </a>
            </div>
        {% endfor %}
    </div>
    <div id="loading" style="text-align: center; margin-top: 20px; display: none;">
        <p>Загрузка...</p>
    </div>
</div>

<script>
    let page = 2;
    let isLoading = false;

    function loadMoreProducts() {
        if (isLoading) return;
        isLoading = true;
        document.getElementById('loading').style.display = 'block';
        
        fetch(`/api/products/?page=${page}`)
            .then(response => response.json())
            .then(data => {
                const productList = document.getElementById('product-list');
                data.products.forEach(product => {
                    const productItem = document.createElement('div');
                    productItem.classList.add('product-item');
                    productItem.innerHTML = `
                        <a href="${product.url}">
                            <img src="${product.image}" alt="${product.name}" class="product-image">
                            <h4 class="product-name">${product.name}</h4>
                            <p class="product-price">${product.price} руб.</p>
                        </a>
                    `;
                    productList.appendChild(productItem);
                });
                page++;
                isLoading = false;
                document.getElementById('loading').style.display = 'none';
                if (!data.has_next) {
                    window.removeEventListener('scroll', handleScroll);
                }
            });
    }

    function handleScroll() {
        const scrollable = document.documentElement.scrollHeight - window.innerHeight;
        const scrolled = window.scrollY;

        if (scrolled >= scrollable - 200) {
            loadMoreProducts();
        }
    }

    window.addEventListener('scroll', handleScroll);
</script>
{% endblock %}
